package com.tmap.model.tool;

import java.util.ArrayList;
import java.util.List;

import com.tmap.library.SystemConfig;
import com.tmap.library.wifi.BssidRssiPair;
import com.tmap.library.wifi.WifiScanner;
import com.tmap.model.tool.arch.TempWifiScanner;
import com.tmap.model.tool.arch.TempWifiScanner.WifiReceiver;

import android.net.wifi.ScanResult;
import android.net.wifi.WifiManager;
import android.os.Bundle;
import android.os.Handler;
import android.app.Activity;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.util.Log;
import android.view.Menu;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;

public class WifiCollector extends Activity {
	public Button upX, upY, upZ, downX, downY, downZ, scan;
	public EditText x, y, z, eachTime;
	public TextView hint;
	public int remaining;
	
	public TempWifiScanner wifiScanner;
	
	private WifiManager wifiManager = null;
	private WifiReceiver wifiReceiver = null;
	
	public ArrayList<BssidRssiPair> scanResult = null;	// BSSID-RSSI pair list
	
	
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.wifi_conllector);
        upX = (Button)this.findViewById(R.id.up_x);
        upY = (Button)this.findViewById(R.id.up_y);
        upZ = (Button)this.findViewById(R.id.up_z);
        downX = (Button)this.findViewById(R.id.down_x);
        downY = (Button)this.findViewById(R.id.down_y);
        downZ = (Button)this.findViewById(R.id.down_z);
        scan = (Button)this.findViewById(R.id.scan);
        
        x = (EditText)this.findViewById(R.id.x);
        y = (EditText)this.findViewById(R.id.y);
        z = (EditText)this.findViewById(R.id.z);
        
        hint = (TextView)this.findViewById(R.id.hint);
        
        eachTime = (EditText)this.findViewById(R.id.each_time);
        
        upX.setOnClickListener(
        	new OnClickListener() {
				@Override
				public void onClick(View arg0) {
					// TODO Auto-generated method stub
					x.setText((Float.parseFloat(x.getText().toString()) + 1) + "");
				}
        	}
        );
        
        upY.setOnClickListener(
           	new OnClickListener() {
    			@Override
    			public void onClick(View arg0) {
    				// TODO Auto-generated method stub
    				y.setText((Float.parseFloat(y.getText().toString()) + 1) + "");
    			}
           	}
        );
        
        upZ.setOnClickListener(
            new OnClickListener() {
    			@Override
    			public void onClick(View arg0) {
   					// TODO Auto-generated method stub
    				z.setText((Float.parseFloat(z.getText().toString()) + 1) + "");
    			}
           	}
        );
        
        downX.setOnClickListener(
            new OnClickListener() {
            	@Override
    			public void onClick(View arg0) {
    				// TODO Auto-generated method stub
    				x.setText((Float.parseFloat(x.getText().toString()) - 1) + "");
   				}
           	}
        );
            
        downY.setOnClickListener(
            new OnClickListener() {
        		@Override
        		public void onClick(View arg0) {
        			// TODO Auto-generated method stub
       				y.setText((Float.parseFloat(y.getText().toString()) - 1) + "");
       			}
          	}
        );
            
        downZ.setOnClickListener(
            new OnClickListener() {
        		@Override
       			public void onClick(View arg0) {
   					// TODO Auto-generated method stub
       				z.setText((Float.parseFloat(z.getText().toString()) - 1) + "");
      			}
           	}
        );
        
        //wifiScanner = new TempWifiScanner(this, handler);
        
        wifiReceiver = new WifiReceiver();
        registerReceiver(wifiReceiver, new IntentFilter(WifiManager.SCAN_RESULTS_AVAILABLE_ACTION));
        wifiManager = (WifiManager) getSystemService(Context.WIFI_SERVICE);
        
        scan.setOnClickListener(
            new OnClickListener() {
           		@Override
       			public void onClick(View arg0) {
   					// TODO Auto-generated method stub
           			scan.setEnabled(false);
           			remaining = Integer.parseInt(((EditText)findViewById(R.id.each_time)).getText().toString());
       				hint.setText("剩余" + remaining + "次");
       				new Thread(new Runnable() {
       					public void run() {
       						wifiManager.startScan();
       					}
       				}).start();
       				
      			}
           	}
        );
    }

    //=======
    public class WifiReceiver extends BroadcastReceiver {
		@Override
		public void onReceive(Context c, Intent i){
			Log.d("src", "Here");
			List<ScanResult> scanResults = wifiManager.getScanResults();
			
			scanResult = new ArrayList<BssidRssiPair>();
			Log.d("src", "Here");
			for (ScanResult scanItem : scanResults) {
				scanResult.add(new BssidRssiPair(scanItem.BSSID, scanItem.level));	
			}
			handler.sendEmptyMessage(SystemConfig.MSG_WIFI_COMPLETE);
		}
	}
    //=======
    
    Handler handler = new Handler() {
    	public void handleMessage(android.os.Message msg) {
            switch(msg.what){
            case SystemConfig.MSG_WIFI_COMPLETE:
            	hint.setText("sending...");
            	for (int i = 0; i < scanResult.size(); ++i) {
            		Log.d("src", wifiScanner.scanResult.get(i).bssid+ " " + wifiScanner.scanResult.get(i).rssi);
            	}
            	if (remaining > 0) {
            		--remaining;
//            		new Thread(new Runnable() {
//       					public void run() {
//       						wifiScanner.scan();
//       					}
//       				}).start();
       				
            	} else {
            		// to do
            		hint.setText("就绪");
            		scan.setEnabled(true);
            	}
            	break;
            }
        };
    };

    @Override
    public boolean onCreateOptionsMenu(Menu menu) {
        // Inflate the menu; this adds items to the action bar if it is present.
        getMenuInflater().inflate(R.menu.main, menu);
        return true;
    }
    
//    @Override
//    public void onPause() {
//    	wifiScanner.onPause();
//    	super.onPause();
//    }
//    
//    @Override
//    public void onResume() {
//    	wifiScanner.onResume();
//    	super.onResume();
//    }
}
