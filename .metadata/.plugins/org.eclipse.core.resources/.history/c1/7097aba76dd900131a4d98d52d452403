package com.tmap.model.tool;

import com.tmap.library.SystemConfig;
import com.tmap.library.server_interface.Location;
import com.tmap.library.wifi.WifiScanner;
import com.tmap.model.tool.arch.ServerConnector;

import android.app.Activity;
import android.content.Intent;
import android.media.Ringtone;
import android.media.RingtoneManager;
import android.net.Uri;
import android.os.Bundle;
import android.os.Handler;
import android.util.Log;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.Button;
import android.widget.EditText;
import android.widget.TextView;
import android.widget.Toast;

public class Locating  extends Activity {
	private Button start_stop, person;
	private EditText xRange, yRange;
	private TextView building, room, location;
	
	private double xLen = 5, yLen = 8;
	
	public WifiScanner wifiScanner;
	
	private boolean isLocating = false;
	
	@Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.locating);
        
        start_stop = (Button)this.findViewById(R.id.start_stop);
        person = (Button)this.findViewById(R.id.person);
        
        xRange = (EditText)this.findViewById(R.id.xRange);
        yRange = (EditText)this.findViewById(R.id.yRange);
        
        building = (TextView)this.findViewById(R.id.building);
        room = (TextView)this.findViewById(R.id.room);
        location = (TextView)this.findViewById(R.id.location);
        
        wifiScanner = new WifiScanner(this, handler);
        
        start_stop.setOnClickListener(
        	new OnClickListener() {
				@Override
				public void onClick(View arg0) {
					// TODO Auto-generated method stub
					isLocating = !isLocating;
					if (isLocating) {
						xRange.setEnabled(false);
						yRange.setEnabled(false);
					} else {
						xRange.setEnabled(true);
						yRange.setEnabled(true);
					}
					xLen = Double.parseDouble(xRange.getText().toString());
					yLen = Double.parseDouble(yRange.getText().toString());
					new Thread(new Runnable() {
       					public void run() {
       						wifiScanner.scan();
       					}
       				}).start();	
				}
        	}
        );
	}
	
	Handler handler = new Handler() {
    	public void handleMessage(android.os.Message msg) {
            switch(msg.what){
            case SystemConfig.MSG_WIFI_COMPLETE:
            	new Thread(new Runnable() {
        			public void run() {
        				try {
							Location location = ServerConnector.getInstance().wifiLocating(wifiScanner.scanResult);
							Log.d("src", location.x+" "+location.y+" "+location.z);
						} catch (Exception e) {
							// TODO Auto-generated catch block
							handler.sendEmptyMessage(SystemConfig.MSG_NET_FAIL);
							e.printStackTrace();
						}
        			}
        		}).start();
            	
            	if (isLocating) {
            		new Thread(new Runnable() {
       					public void run() {
       						try {
    							Thread.sleep(1000);
    						} catch (InterruptedException e) {
    							e.printStackTrace();
    						}
       						wifiScanner.scan();
       					}
       				}).start();	
                	
            	}

            	break;
            case SystemConfig.MSG_NET_FAIL:
            	Toast.makeText(getApplicationContext(), "定位失败", Toast.LENGTH_SHORT).show();
            	break;
            }
            
        };
    };
	
	@Override
    public void onPause() {
    	wifiScanner.onPause();
    	super.onPause();
    }
    
    @Override
    public void onResume() {
    	wifiScanner.onResume();
    	super.onResume();
    }
}
